//!function(e){e.fn.btsListFilter=function(t,n){"use strict";function i(e,t){return e.replace(/\{ *([\w_]+) *\}/g,function(e,n){return t[n]||""})}var s,a,l=this,r=e(this),o=e(t),c=r;return n=e.extend({delay:300,minLength:1,initial:!0,casesensitive:!1,eventKey:"keyup",resetOnBlur:!0,sourceData:null,sourceTmpl:'<a class="list-group-item" href="#"><span>{title}</span></a>',sourceNode:function(e){return i(n.sourceTmpl,e)},emptyNode:function(e){return'<a class="list-group-item well" href="#"><span>Данного города нет</span></a>'},cancelNode:function(){return'<span class="btn fa fa-remove form-control-feedback" aria-hidden="true"></span>'},loadingClass:"bts-loading-list",itemClassTmp:"bts-dynamic-item",itemEl:".list-group-item",itemChild:null,itemFilter:function(t,i){i=i&&i.replace(new RegExp("[({[^.$*+?\\]})]","g"),"");var s=e(t).text(),a=n.initial?"^":"";return new RegExp(a+i,n.casesensitive?"":"i").test(s)}},n),l.reset=function(){o.val("").trigger(n.eventKey)},e.isFunction(n.cancelNode)&&(s=e(n.cancelNode.call(l)).hide(),o.after(s),o.parents(".form-group").addClass("has-feedback"),o.prev().is(".control-label")||s.css({top:0}),s.css({"pointer-events":"auto"}),s.on("click",l.reset)),o.on(n.eventKey,function(e,t){var n;return t=t||300,function(){var i=this,s=arguments;clearTimeout(n),n=setTimeout(function(){e.apply(i,Array.prototype.slice.call(s))},t)}}(function(t){var i=e(this).val();n.itemEl&&(c=r.find(n.itemEl)),n.itemChild&&(c=c.find(n.itemChild));var o=c.filter(function(){return n.itemFilter.call(l,this,i)}),u=c.not(o);n.itemChild&&(o=o.parents(n.itemEl),u=u.parents(n.itemEl).hide()),""!==i&&i.length>=n.minLength?(o.show(),u.hide(),s.show(),"function"===e.type(n.sourceData)?(o.hide(),u.hide(),a&&(e.isFunction(a.abort)?a.abort():e.isFunction(a.stop)&&a.stop()),r.addClass(n.loadingClass),a=n.sourceData.call(l,i,function(t){if(a=null,o.hide(),u.hide(),r.find("."+n.itemClassTmp).remove(),t&&0!==t.length)for(var s in t)e(n.sourceNode.call(l,t[s])).addClass(n.itemClassTmp).appendTo(r);else e(n.emptyNode.call(l,i)).addClass(n.itemClassTmp).appendTo(r);r.removeClass(n.loadingClass)})):(r.find("."+n.itemClassTmp).remove(),0===o.length&&e(n.emptyNode.call(l,i)).addClass(n.itemClassTmp).appendTo(r))):(o.show(),u.show(),s.hide(),r.find("."+n.itemClassTmp).remove())},n.delay)),n.resetOnBlur&&o.on("blur",function(e){l.reset()}),r}}(jQuery);
/*
* OPTIONS
*
* delay        *millisecond before apply filter*
* minLength    *min string lentgh searched*
* initial      *search only initial text (default: true)*
* eventKey     *event digit (default: 'keyup')*
* resetOnBlur  *auto reset selection*
* sourceData   *function generate data source(receive: text, callback)*
* sourceTmpl   *html template contains {title} placeholder*
* sourceNode   *function builder DOM html fragment (default: sourceTmpl)*
* emptyNode    *function builder for empty result*
* itemEl       *item selector (default: .list-group-item)*,
* itemChild    *sub item selector (default: .list-group-item)*,
* itemFilter   *function for filter results(receive: text, item)*
*/
(function($) {
	$.fn.btsListFilter = function(inputEl, opts) {

		'use strict';

		var self = this,
			searchlist$ = $(this),
			inputEl$ = $(inputEl),
			cancelEl$,
			items$ = searchlist$,
			callData,
			callReq;	//last callData execution

		function tmpl(str, data) {
			return str.replace(/\{ *([\w_]+) *\}/g, function (str, key) {
				return data[key] || '';
			});
		}

		function defaultItemFilter(item, val) {
			val = val && val.replace(new RegExp("[({[^.$*+?\\\]})]","g"),'');
			//sanitize regexp

			var text = $(item).text(),
				i = opts.initial ? '^' : '',
				regSearch = new RegExp(i + val, opts.casesensitive ? '' : 'i');

			return regSearch.test( text );
		}

		opts = $.extend({
			delay: 300,
			minLength: 1,
			initial: true,
			casesensitive: false,
			eventKey: 'keyup',
			resetOnBlur: true,
			sourceData: null,
			sourceTmpl: '<a class="list-group-item" href="#"><span>{title}</span></a>',
			sourceNode: function(data) {
				return tmpl(opts.sourceTmpl, data);
			},
			emptyNode: function(data) {
				return '<a class="list-group-item well" href="#"><span>Данного города нет</span></a>';
			},
			cancelNode: function() {
				return '<span class="btn fa fa-remove form-control-feedback" aria-hidden="true"></span>';
			},
			loadingClass: 'bts-loading-list',
			itemClassTmp: 'bts-dynamic-item',
			itemEl: '.list-group-item',
			itemChild: null,
			itemFilter: defaultItemFilter
		}, opts);

		function debouncer(func, timeout) {
			var timeoutID;
			timeout = timeout || 300;
			return function () {
				var scope = this , args = arguments;
				clearTimeout( timeoutID );
				timeoutID = setTimeout( function () {
					func.apply( scope , Array.prototype.slice.call( args ) );
				}, timeout);
			};
		}

		self.reset = function() {
			inputEl$.val('').trigger(opts.eventKey);
		};

		if($.isFunction(opts.cancelNode)) {

			cancelEl$ = $(opts.cancelNode.call(self)).hide();

			inputEl$.after( cancelEl$ );
			inputEl$.parents('.form-group').addClass('has-feedback');

			if(!inputEl$.prev().is('.control-label'))
				cancelEl$.css({top: 0});

			cancelEl$.css({'pointer-events': 'auto'});

			cancelEl$.on('click', self.reset);
		}

		inputEl$.on(opts.eventKey, debouncer(function(e) {

			var val = $(this).val();

			if(opts.itemEl)
				items$ = searchlist$.find(opts.itemEl);

			if(opts.itemChild)
				items$ = items$.find(opts.itemChild);

			var contains = items$.filter(function(){
					return opts.itemFilter.call(self, this, val);
				}),
				containsNot = items$.not(contains);

			if (opts.itemChild){
				contains = contains.parents(opts.itemEl);
				containsNot = containsNot.parents(opts.itemEl).hide();
			}

			if(val!=='' && val.length >= opts.minLength)
			{
				contains.show();
				containsNot.hide();
				cancelEl$.show();

				if($.type(opts.sourceData)==='function')
				{
					contains.hide();
					containsNot.hide();

					if(callReq)
					{
						if($.isFunction(callReq.abort))
							callReq.abort();
						else if($.isFunction(callReq.stop))
							callReq.stop();
					}

					searchlist$.addClass(opts.loadingClass);
					callReq = opts.sourceData.call(self, val, function(data) {
						callReq = null;
						contains.hide();
						containsNot.hide();
						searchlist$.find('.'+opts.itemClassTmp).remove();

						if(!data || data.length===0)
							$( opts.emptyNode.call(self, val) ).addClass(opts.itemClassTmp).appendTo(searchlist$);
						else
							for(var i in data)
								$( opts.sourceNode.call(self, data[i]) ).addClass(opts.itemClassTmp).appendTo(searchlist$);

						searchlist$.removeClass(opts.loadingClass);
					});
				}
				else {
                    searchlist$.find('.'+opts.itemClassTmp).remove();

                    if(contains.length===0)
						$( opts.emptyNode.call(self, val) ).addClass(opts.itemClassTmp).appendTo(searchlist$);
				}

			}
			else
			{
				contains.show();
				containsNot.show();
				cancelEl$.hide();
				searchlist$.find('.'+opts.itemClassTmp).remove();
			}
		}, opts.delay));

		if(opts.resetOnBlur)
			inputEl$.on('blur', function(e) {
				self.reset();
			});

		return searchlist$;
	};

})(jQuery);
